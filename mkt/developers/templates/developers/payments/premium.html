{% extends 'developers/base_impala.html' %}
{% from 'developers/includes/macros.html' import empty_unless, required, some_html_tip, tip %}

{% set title = _('Compatibility & Payments') %}
{% block title %}{{ hub_page_title(title, addon) }}{% endblock %}

{% set can_edit = check_addon_ownership(request, addon) %}
{% block bodyclass %}
  {{ super() }}{% if not can_edit %} no-edit{% endif %}
{% endblock %}

{%- macro button(id, slug, name, extra_class) -%}
<div class="wrapper">
  <a href="#" id="{{ slug }}" class="choice island{% if extra_class %} {{ extra_class }}{% endif %}" data-value="{{ id }}" draggable="false">
    <h3>{{ name }}</h3>
    <div class="listing-footer"><input type="checkbox"></div>
  </a>
</div>
{%- endmacro %}

{% block content %}
  <header>
    {{ hub_breadcrumbs(addon, items=[(None, title)]) }}
    <h1>{{ title }}</h1>
  </header>
  <section class="primary payments devhub-form" role="main"
           data-packaged-platforms="{{ 'android' if waffle.flag('android-packaged') }} {{ 'desktop' if waffle.flag('desktop-packaged') }}"
           data-payment-platforms="{{ 'android' if waffle.flag('android-payments') }}">
    <form action="{{ addon.get_dev_url('payments') }}" method="post">
      {{ csrf() }}
      <input type="hidden" name="toggle-paid" value="" />

      <div class="hidden">
        {{ form.app_type }}
        {{ form.payment }}
        {{ form.platform }}
        {{ form.form_factor }}
      </div>

      <section id="submit-payment-type">
        {% if not is_paid %}
          <h2>{{ _('App Compatibility') }}</h2>
        {% endif %}

        <div class="island hasappendix tabbable">
          <div class="free tab {{ 'active' if not is_paid }}">
            <h2 id="free-tab-header"><a href="#">{{ _('Free') }}</a></h2>
            <div class="error">{{ form.errors.form_factor }}</div>
            {{ button(0, 'free-responsive', _('Responsive')) }}
            {%- for slug, ff in free_forms -%}
              {{ button(ff.id, 'free-' + ff.slug, ff.name, 'free-choices') }}
            {%- endfor %}

            {% if is_paid %}
              <div id="free-tab-save" class="update-payment-type">
                <button data-type="free">{{ _('Change to Free') }}</button>
                {{ _('Changing to Free will put your app back into review.') }}
              </div>
            {% endif %}
          </div>

          <div class="paid tab {{ 'active' if is_paid }}">
            <h2 id="paid-tab-header">
              <a href="#"{% if cannot_be_paid %} class="disabled"{% endif %}>{{ _('Paid / In-app') }}</a>
            </h2>
            <div class="error"></div>
            {{ button(0, 'paid-responsive', _('Responsive')) }}
            {%- for slug, ff in paid_forms -%}
              {{ button(ff.id, 'paid-' + ff.slug, ff.name, 'paid-choices') }}
            {%- endfor %}

            {% if not is_paid and not cannot_be_paid %}
              <div id="paid-tab-save" class="update-payment-type">
                <button data-type="paid">{{ _('Change to Paid') }}</button>
                {{ _('Changing to Paid will put your app back into review.') }}
              </div>
            {% endif %}
            <div class="helpful-links">
              {% trans payments_url='https://developer.mozilla.org/en-US/docs/Apps/Marketplace_Payments',
                       receipts_url='https://developer.mozilla.org/en-US/docs/Apps/Validating_a_receipt' %}
               Learn about <a href="{{ payments_url }}" target="_blank">different payment types</a>.<br />
               Learn about <a href="{{ receipts_url }}" target="_blank">validating purchase receipts</a>.
              {% endtrans %}
            </div>
          </div>

          <div id="upload-platforms">
            <h3>{{ _('Additional Platforms') }}</h3>
            <p>{{ _('In addition to Firefox devices I would also like my app listed '
                    'in the Marketplace for users of:') }}</p>
            <label>
              <input type="checkbox" id="platform-android" {% if 'android' in platforms %} checked="checked"{% endif %}> {{ _('Android') }}
            </label>
          </div>

          <div id="compat-save-button" class="update-payment-type hidden">
            <button class="button">{{ _('Save Changes') }}</button>
          </div>
        </div>
      </section>

      {% if is_paid %}
      <h2>{{ _('Payment Accounts') }}</h2>

      <div id="paid-island">
        {{ disabled_payments_notice() }}
        <div id="paid-island-incomplete" class="island warning{% if not has_incomplete_status %} hidden{% endif %}">
          {%- trans %}
            Your app is currently incomplete. Select a payment account and
            price point to restore it.
          {% endtrans -%}
        </div>
        <section class="island payments">
          {{ account_list_formset.management_form }}
          <table>
            <tbody>
              {% for account_list_form in account_list_formset.forms %}
                {% with provider=account_list_form.provider %}
                  <tr>
                    <th>
                      <label data-for="accounts">
                        <img src="{{ MEDIA_URL }}img/developers/logo-{{ provider.name }}.png" title="{{ provider.full }}">
                      </label>
                    </th>
                    <td>
                      <div id="{{ provider.name }}-account-list" data-url="{{ url('mkt.developers.provider.payment_accounts_form') }}?provider={{ provider.name }}&app_slug={{ addon.app_slug }}">
                        {{ account_list_form.errors }}
                        {% include 'developers/payments/includes/accounts_list.html' %}
                      </div>
                    </td>
                  </tr>
                {% endwith %}
              {% endfor %}
            </tbody>
          </table>
          <div class="listing-footer">
            {% if can_edit and account_list_forms[0].is_owner %}
              <a href="#" class="payment-account-note" id="payment-account-action" data-action="add">
                {{- _('Add, manage or view transactions for your payment accounts') -}}
              </a>
            {% endif %}
            <button>{{ _('Save Changes') }}</button>
          </div>
        </section>
      </div>
      {% endif %}

      {% if is_paid %}
      <h2>{{ _('Prices and Countries') }}</h2>

      <div id="paid-regions-island">
        <section id="regions" class="island">
          <table>
            <tbody>
              <tr>
                <th><label data-for="price">{{ _('Price') }}</label></th>
                <td>
                  {{ form.price.errors }}
                  {{ form.price }}
                </td>
              </tr>
              <tr>
                <th>
                  {{ tip(_('In-App Payments'),
                         _("Does your app use Mozilla's in-app payments platform?")) }}
                </th>
                <td class="allow-inapp">
                  {{ form.allow_inapp.errors }}
                  {{ form.allow_inapp }}
                </td>
              </tr>
              <tr>
                <td colspan="2" class="region-container">
                  <div id="region-list" class="checkbox-choices regions"
                       data-api-error-msg="{{ _('A server error occurred. Please try again later.') }}"
                       data-all-paid-region-ids="{{ all_paid_region_ids_by_slug|json }}"
                       data-special-regions="{{ region_form.special_region_ids|json }}"
                       data-special-region-statuses="{{ region_form.special_region_statuses|json }}"
                       {# XXX: We are not using JS gettext because we have had some bugs with JS extraction lately. #}
                       data-special-region-l10n="{{ region_form.special_region_messages|json }}"
                       data-not-applicable-msg="{{ _('Not applicable') }}"
                       data-payment-methods="{{ payment_methods|json }}"
                       data-pricelist-api-url="{{ api_pricelist_url }}"
                       data-tier-zero-id="{{ tier_zero_id }}"
                       data-provider-lookup="{{ provider_lookup|json }}">
                    <h3>{{ _('Regions') }}</h3>
                    {{ region_form.regions.errors }}

                    {% include 'developers/payments/includes/regions_toggle.html' %}

                    <div class="paid-regions">
                      <h4>{{ _('Available Regions') }}</h4>

                      {% include 'developers/payments/includes/special_regions.html' %}

                      <p class="hint note">
                        {% trans status_url='https://developer.mozilla.org/docs/Mozilla/Marketplace/Payments_Status' %}
                          Check out the <a href="{{ status_url }}" target="_blank">status page</a> to see which
                          countries are currently enabled for sale.
                        {% endtrans %}
                      </p>

                      <p class="hint note">
                        {{ _('Your app will be available in the following selected regions:') }}
                      </p>
                      <table id="paid-regions">
                        <thead>
                          <tr>
                            <th><span class="region-heading">{{ _('Region') }}</span></th>
                            <th>{{ _('Retail price') }}
                              <span class="local-currency-heading">({{ _('local currency') }})</span></th>
                            <th>{{ _('Billing method') }}</th>
                          </tr>
                        </thead>
                        <tbody class="checkbox-choices">
                          {% for id in all_paid_region_ids_by_slug %}
                            <tr data-region="{{ id }}"></tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>

                    <h4>{{ _("Other regions") }}</h4>
                    <p class="hint note">
                      {% trans %}
                        Your app will become available in the following
                        selected regions once payments become available
                        based on your chosen price point. To exclude
                        your app from appearing in a region, you may
                        uncheck that region before saving.
                      {% endtrans %}
                    </p>
                    {% include 'developers/payments/includes/region_form.html' %}

                  </div>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="listing-footer">
            <button class="button">{{ _('Save Changes') }}</button>
          </div>
        </section>
      </div>
      {% else %}
      {# Non-paid app region lists #}
      <h2>{{ _('Regions and Listings') }}</h2>

      <div id="regions-island">
        <section id="regions" class="island">
          {% include 'developers/payments/includes/special_regions.html' %}
          {% include 'developers/payments/includes/regions_toggle.html' %}
          {% include 'developers/payments/includes/region_form.html' %}
          <div class="listing-footer">
            <button class="button">{{ _('Save Changes') }}</button>
          </div>
        </section>
      </div>
      {% endif %}

      {% if is_paid %}
      <h2>{{ _('Promote as upgrade to free version') }}</h2>

      <div id="paid-upsell-island">
        {{ disabled_payments_notice() }}
        <section class="island upsell">
          <table>
            <tbody>
              <tr>
                <th>
                  {{ tip(_('This is a paid upgrade of'),
                         _('If you have a free app, you can link and promote '
                           'your premium app next to the free version here.')) }}
                </th>
                <td>
                  {% if upsell_form.fields['upsell_of'].queryset.count() %}
                    {{ upsell_form.upsell_of.errors }}
                    {{ upsell_form.upsell_of }}
                    <p class="note">
                      {% trans %}
                        Linking this app will promote your premium app next to the free
                        version.
                      {% endtrans %}
                    </p>
                  {% else %}
                    <div class="extra">
                      {{- _('No free apps') -}}
                    </div>
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
          <div class="listing-footer">
            <button>{{ _('Save Changes') }}</button>
          </div>
        </section>
      </div>
      {% endif %}
    </form>
  </section>

  {% include 'developers/includes/addons_edit_nav.html' %}
  {% include 'developers/payments/includes/account_list.html' %}
  {% for provider in providers %}
    {% with account_form=provider.forms['account']() %}
      {% include provider.templates['add'] %}
      {% include provider.templates['edit'] %}
    {% endwith %}
  {% endfor %}
  {% include 'developers/payments/includes/accept_terms.html' %}
{% endblock %}
